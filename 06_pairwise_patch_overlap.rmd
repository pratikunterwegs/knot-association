---
editor_options: 
  chunk_output_type: console
---

# Within and between patch variance in traits

Here we relate the extent of temporal and spatial overlap to pairwise differences in traits.

## Read in patch data and overlaps

```{r}
library(readr)
library(ggplot2)
library(scales)
library(tidyr); library(tibble)
library(magrittr)
library(dplyr)
library(purrr)

# stats
library(lmerTest)

# ci fun
ci <- function(x){qnorm(0.975)*sd(x, na.rm = T)/sqrt((length(x)))}
```

```{r}
# read in patch data
data_patches <- read_csv("data/data2018/data_2018_patch_summary_has_patches.csv")
# read in overlap data
data <- read_csv("data/data2018/data_spatio_temporal_overlap_2018.csv")
```

## Determine tidal cycle and tidal stage

### Link overlaps with patch data

```{r}
# add a uid
data_patches <- mutate(data_patches, uid = 1:nrow(data_patches))

# select columns
data_patches <- select(data_patches,
                       id, uid, tide_number, waterlevel_mean)

# link overlaps with patches
data <- left_join(data, data_patches,
                  by = c("patch_i_unique_id" = "uid")) %>% 
  left_join(data_patches,
            by = c("patch_j_unique_id" = "uid"))
```

### Get consensus tide number waterlevel

The tide number and tidal stage will be used to divide the overlaps into classes, so that we can examine community structure in a particular tide and at a certain tidal stage.

```{r}
# get the consensus tide as first and the mean waterlevel
data <- data %>% 
  mutate(tide_number_consensus = first(tide_number.x, tide_number.y),
         waterlevel_consensus = mean(c(waterlevel_mean.x, waterlevel_mean.y)))

# remove bad cols and classify as high or low tide
data <- data %>% 
  rename(id_x = id.x, id_y = id.y) %>% 
  select(-contains(c(".x", ".y")))
data <- data %>% 
  mutate(tide_stage = if_else(waterlevel_consensus < 55, "low", "high")) %>% 
  select(-waterlevel_consensus)
```


This data needs to be exported and passed to `igraph`, where for each tide--tide-stage, we cosntruct a separate network, and get the assortativity of the nodes (individuals!) on different traits. These traits will be added below.

## Link overlap with id data

### Add some biometric data

```{r}
# add individual data to patch data
data_id <- read_csv("data/data2018/SelinDB.csv") %>% 
  filter(!is.na(Toa_Tag)) %>% 
  select(Toa_Tag, 
         wing = WING, mass = MASS, 
         gizzard_mass) %>% 
  drop_na()

# merge the patches with id data on i
data <- left_join(data, data_id,
                  by = c("id_x" = "Toa_Tag")) %>% 
  left_join(data_id, by = c("id_y" = "Toa_Tag"))
```

### Export for igraph

```{r}
write_csv(data, "data/data2018/data_trait_and_id_overlap_by_group.csv")
```

