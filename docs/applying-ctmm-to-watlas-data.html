<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Applying CTMM to WATLAS data | Individual consistency in space-use across scales</title>
  <meta name="description" content="8 Applying CTMM to WATLAS data | Individual consistency in space-use across scales" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Applying CTMM to WATLAS data | Individual consistency in space-use across scales" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="8 Applying CTMM to WATLAS data | Individual consistency in space-use across scales" />
  <meta name="github-repo" content="pratikunterwegs/knotPatches" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Applying CTMM to WATLAS data | Individual consistency in space-use across scales" />
  
  <meta name="twitter:description" content="8 Applying CTMM to WATLAS data | Individual consistency in space-use across scales" />
  

<meta name="author" content="Pratik R Gupte" />


<meta name="date" content="2020-02-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="linking-patch-metrics-to-personality.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<script src="libs/elevate-section-attrs-2.0/elevate-section-attrs.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#attribution"><i class="fa fa-check"></i><b>1.1</b> Attribution</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data-access"><i class="fa fa-check"></i><b>1.2</b> Data access</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#data-processing"><i class="fa fa-check"></i><b>1.3</b> Data processing</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="getting-data.html"><a href="getting-data.html"><i class="fa fa-check"></i><b>2</b> Getting data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="getting-data.html"><a href="getting-data.html#prepare-watlasutils-and-other-libraries"><i class="fa fa-check"></i><b>2.1</b> Prepare <code>watlasUtils</code> and other libraries</a></li>
<li class="chapter" data-level="2.2" data-path="getting-data.html"><a href="getting-data.html#read-in-tag-deployment-data"><i class="fa fa-check"></i><b>2.2</b> Read in tag deployment data</a></li>
<li class="chapter" data-level="2.3" data-path="getting-data.html"><a href="getting-data.html#get-data-and-save-locally"><i class="fa fa-check"></i><b>2.3</b> Get data and save locally</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="cleaning-data.html"><a href="cleaning-data.html"><i class="fa fa-check"></i><b>3</b> Cleaning data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="cleaning-data.html"><a href="cleaning-data.html#prepare-watlasutils-and-other-libraries-1"><i class="fa fa-check"></i><b>3.1</b> Prepare <code>watlasUtils</code> and other libraries</a></li>
<li class="chapter" data-level="3.2" data-path="cleaning-data.html"><a href="cleaning-data.html#prepare-to-remove-attractor-points"><i class="fa fa-check"></i><b>3.2</b> Prepare to remove attractor points</a></li>
<li class="chapter" data-level="3.3" data-path="cleaning-data.html"><a href="cleaning-data.html#read-clean-and-write-data"><i class="fa fa-check"></i><b>3.3</b> Read, clean, and write data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="adding-tidal-cycle-data.html"><a href="adding-tidal-cycle-data.html"><i class="fa fa-check"></i><b>4</b> Adding tidal cycle data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="adding-tidal-cycle-data.html"><a href="adding-tidal-cycle-data.html#prepare-libraries"><i class="fa fa-check"></i><b>4.1</b> Prepare libraries</a></li>
<li class="chapter" data-level="4.2" data-path="adding-tidal-cycle-data.html"><a href="adding-tidal-cycle-data.html#read-water-level-data"><i class="fa fa-check"></i><b>4.2</b> Read water level data</a></li>
<li class="chapter" data-level="4.3" data-path="adding-tidal-cycle-data.html"><a href="adding-tidal-cycle-data.html#calculate-high-tides"><i class="fa fa-check"></i><b>4.3</b> Calculate high tides</a></li>
<li class="chapter" data-level="4.4" data-path="adding-tidal-cycle-data.html"><a href="adding-tidal-cycle-data.html#add-time-since-high-tide"><i class="fa fa-check"></i><b>4.4</b> Add time since high tide</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="revisit-analysis.html"><a href="revisit-analysis.html"><i class="fa fa-check"></i><b>5</b> Revisit analysis</a>
<ul>
<li class="chapter" data-level="5.1" data-path="revisit-analysis.html"><a href="revisit-analysis.html#prepare-libraries-1"><i class="fa fa-check"></i><b>5.1</b> Prepare libraries</a></li>
<li class="chapter" data-level="5.2" data-path="revisit-analysis.html"><a href="revisit-analysis.html#read-data-split-recurse-write"><i class="fa fa-check"></i><b>5.2</b> Read data, split, recurse, write</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="residence-patch-construction.html"><a href="residence-patch-construction.html"><i class="fa fa-check"></i><b>6</b> Residence patch construction</a>
<ul>
<li class="chapter" data-level="6.1" data-path="residence-patch-construction.html"><a href="residence-patch-construction.html#prepare-libraries-2"><i class="fa fa-check"></i><b>6.1</b> Prepare libraries</a></li>
<li class="chapter" data-level="6.2" data-path="residence-patch-construction.html"><a href="residence-patch-construction.html#patch-construction"><i class="fa fa-check"></i><b>6.2</b> Patch construction</a></li>
<li class="chapter" data-level="6.3" data-path="residence-patch-construction.html"><a href="residence-patch-construction.html#get-patch-trajectories"><i class="fa fa-check"></i><b>6.3</b> Get patch trajectories</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="linking-patch-metrics-to-personality.html"><a href="linking-patch-metrics-to-personality.html"><i class="fa fa-check"></i><b>7</b> Linking patch metrics to personality</a>
<ul>
<li class="chapter" data-level="7.1" data-path="linking-patch-metrics-to-personality.html"><a href="linking-patch-metrics-to-personality.html#prepare-libraries-3"><i class="fa fa-check"></i><b>7.1</b> Prepare libraries</a></li>
<li class="chapter" data-level="7.2" data-path="linking-patch-metrics-to-personality.html"><a href="linking-patch-metrics-to-personality.html#read-in-exploration-score"><i class="fa fa-check"></i><b>7.2</b> Read in exploration score</a></li>
<li class="chapter" data-level="7.3" data-path="linking-patch-metrics-to-personality.html"><a href="linking-patch-metrics-to-personality.html#exploratory-analysis-on-patch-metrics"><i class="fa fa-check"></i><b>7.3</b> Exploratory analysis on patch metrics</a></li>
<li class="chapter" data-level="7.4" data-path="linking-patch-metrics-to-personality.html"><a href="linking-patch-metrics-to-personality.html#patch-metrics-as-an-outcome-of-exploration-score"><i class="fa fa-check"></i><b>7.4</b> Patch metrics as an outcome of exploration score</a></li>
<li class="chapter" data-level="7.5" data-path="linking-patch-metrics-to-personality.html"><a href="linking-patch-metrics-to-personality.html#plot-model-figures"><i class="fa fa-check"></i><b>7.5</b> Plot model figures</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html"><i class="fa fa-check"></i><b>8</b> Applying CTMM to WATLAS data</a>
<ul>
<li class="chapter" data-level="8.1" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#load-libraries"><i class="fa fa-check"></i><b>8.1</b> Load libraries</a></li>
<li class="chapter" data-level="8.2" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#load-a-random-subset-of-data"><i class="fa fa-check"></i><b>8.2</b> Load a random subset of data</a></li>
<li class="chapter" data-level="8.3" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#choose-scales-of-aggregation"><i class="fa fa-check"></i><b>8.3</b> Choose scales of aggregation</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Individual consistency in space-use across scales</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="applying-ctmm-to-watlas-data" class="section level1">
<h1 number="8"><span class="header-section-number">8</span> Applying CTMM to WATLAS data</h1>
<p>CTMM <span class="citation">(Calabrese, Fleming, and Gurarie <a href="applying-ctmm-to-watlas-data.html#ref-calabrese2016" role="doc-biblioref">2016</a>)</span> can estimate speed from poor quality data. However, CTMM has its limits, and fails most frequently <em>when the movement model is identified as being fractal</em>. A solution to this is to decrease the temporal resolution of the data <em>within</em> residence patches, i.e., to aggregate positions over a certain interval. However, data resulting from this procedure may run afoul of another CTMM feature, <em>outlier removal</em>, which may recommend the removal of nearly all points in a trajectory. This depends on the percentile of the data (in terms of speed and distance from the centroid(?)) considered to be outliers, as well as on the scale of aggregation used earlier to avoid fractal movement models.</p>
<p>Here, we examine the effect of different aggregation scales on the proportion of patches that would be discarded.</p>
<div id="load-libraries" class="section level2">
<h2 number="8.1"><span class="header-section-number">8.1</span> Load libraries</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="applying-ctmm-to-watlas-data.html#cb24-1"></a><span class="co"># load libs</span></span>
<span id="cb24-2"><a href="applying-ctmm-to-watlas-data.html#cb24-2"></a><span class="kw">library</span>(data.table)</span>
<span id="cb24-3"><a href="applying-ctmm-to-watlas-data.html#cb24-3"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb24-4"><a href="applying-ctmm-to-watlas-data.html#cb24-4"></a><span class="kw">library</span>(sf)</span>
<span id="cb24-5"><a href="applying-ctmm-to-watlas-data.html#cb24-5"></a><span class="kw">library</span>(glue)</span>
<span id="cb24-6"><a href="applying-ctmm-to-watlas-data.html#cb24-6"></a><span class="kw">library</span>(stringr)</span>
<span id="cb24-7"><a href="applying-ctmm-to-watlas-data.html#cb24-7"></a><span class="kw">library</span>(fasttime)</span>
<span id="cb24-8"><a href="applying-ctmm-to-watlas-data.html#cb24-8"></a><span class="kw">library</span>(tibble)</span>
<span id="cb24-9"><a href="applying-ctmm-to-watlas-data.html#cb24-9"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb24-10"><a href="applying-ctmm-to-watlas-data.html#cb24-10"></a><span class="kw">library</span>(purrr)</span>
<span id="cb24-11"><a href="applying-ctmm-to-watlas-data.html#cb24-11"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb24-12"><a href="applying-ctmm-to-watlas-data.html#cb24-12"></a></span>
<span id="cb24-13"><a href="applying-ctmm-to-watlas-data.html#cb24-13"></a><span class="co"># devtools::install_github(&quot;pratikunterwegs/watlasUtils&quot;, ref = &quot;devbranch&quot;)</span></span>
<span id="cb24-14"><a href="applying-ctmm-to-watlas-data.html#cb24-14"></a><span class="kw">library</span>(watlasUtils)</span>
<span id="cb24-15"><a href="applying-ctmm-to-watlas-data.html#cb24-15"></a><span class="kw">library</span>(ctmm)</span>
<span id="cb24-16"><a href="applying-ctmm-to-watlas-data.html#cb24-16"></a></span>
<span id="cb24-17"><a href="applying-ctmm-to-watlas-data.html#cb24-17"></a><span class="co"># plot libs</span></span>
<span id="cb24-18"><a href="applying-ctmm-to-watlas-data.html#cb24-18"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb24-19"><a href="applying-ctmm-to-watlas-data.html#cb24-19"></a><span class="kw">library</span>(ggthemes)</span></code></pre></div>
</div>
<div id="load-a-random-subset-of-data" class="section level2">
<h2 number="8.2"><span class="header-section-number">8.2</span> Load a random subset of data</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="applying-ctmm-to-watlas-data.html#cb25-1"></a><span class="co"># make a list of data files to read</span></span>
<span id="cb25-2"><a href="applying-ctmm-to-watlas-data.html#cb25-2"></a>data_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="st">&quot;data/data2018/revisitData&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;_revisit.csv&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb25-3"><a href="applying-ctmm-to-watlas-data.html#cb25-3"></a></span>
<span id="cb25-4"><a href="applying-ctmm-to-watlas-data.html#cb25-4"></a><span class="co"># select a random subset of around 1%</span></span>
<span id="cb25-5"><a href="applying-ctmm-to-watlas-data.html#cb25-5"></a>data_files &lt;-<span class="st"> </span>data_files[<span class="kw">runif</span>(<span class="kw">length</span>(data_files)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.01</span>]</span></code></pre></div>
</div>
<div id="choose-scales-of-aggregation" class="section level2">
<h2 number="8.3"><span class="header-section-number">8.3</span> Choose scales of aggregation</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="applying-ctmm-to-watlas-data.html#cb26-1"></a>scales &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">60</span>)</span>
<span id="cb26-2"><a href="applying-ctmm-to-watlas-data.html#cb26-2"></a></span>
<span id="cb26-3"><a href="applying-ctmm-to-watlas-data.html#cb26-3"></a>data_to_test &lt;-<span class="st"> </span><span class="kw">crossing</span>(scales, data_files)</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="applying-ctmm-to-watlas-data.html#cb27-1"></a><span class="kw">rm</span>(data_files, scales)</span>
<span id="cb27-2"><a href="applying-ctmm-to-watlas-data.html#cb27-2"></a>some_output &lt;-<span class="st"> </span><span class="kw">pmap</span>(data_to_test, <span class="cf">function</span>(scales, data_files){</span>
<span id="cb27-3"><a href="applying-ctmm-to-watlas-data.html#cb27-3"></a>  {</span>
<span id="cb27-4"><a href="applying-ctmm-to-watlas-data.html#cb27-4"></a>    temp_data &lt;-<span class="st"> </span><span class="kw">fread</span>(data_files[[<span class="dv">1</span>]])</span>
<span id="cb27-5"><a href="applying-ctmm-to-watlas-data.html#cb27-5"></a>    temp_data[,ts<span class="op">:</span><span class="er">=</span><span class="kw">fastPOSIXct</span>(ts)]</span>
<span id="cb27-6"><a href="applying-ctmm-to-watlas-data.html#cb27-6"></a>    </span>
<span id="cb27-7"><a href="applying-ctmm-to-watlas-data.html#cb27-7"></a>    id &lt;-<span class="st"> </span><span class="kw">unique</span>(temp_data<span class="op">$</span>id)</span>
<span id="cb27-8"><a href="applying-ctmm-to-watlas-data.html#cb27-8"></a>    tide_number &lt;-<span class="st"> </span><span class="kw">unique</span>(temp_data<span class="op">$</span>tide_number)</span>
<span id="cb27-9"><a href="applying-ctmm-to-watlas-data.html#cb27-9"></a>    </span>
<span id="cb27-10"><a href="applying-ctmm-to-watlas-data.html#cb27-10"></a>    <span class="co"># wrap process in try catch</span></span>
<span id="cb27-11"><a href="applying-ctmm-to-watlas-data.html#cb27-11"></a>    patch_points =<span class="st"> </span><span class="kw">tryCatch</span>(</span>
<span id="cb27-12"><a href="applying-ctmm-to-watlas-data.html#cb27-12"></a>      {</span>
<span id="cb27-13"><a href="applying-ctmm-to-watlas-data.html#cb27-13"></a>        <span class="co"># watlasUtils function to infer residence</span></span>
<span id="cb27-14"><a href="applying-ctmm-to-watlas-data.html#cb27-14"></a>        temp_data &lt;-<span class="st"> </span><span class="kw">wat_infer_residence</span>(<span class="dt">df =</span> temp_data,</span>
<span id="cb27-15"><a href="applying-ctmm-to-watlas-data.html#cb27-15"></a>                                         <span class="dt">infResTime =</span> <span class="dv">2</span>,</span>
<span id="cb27-16"><a href="applying-ctmm-to-watlas-data.html#cb27-16"></a>                                         <span class="dt">infPatchTimeDiff =</span> <span class="dv">30</span>,</span>
<span id="cb27-17"><a href="applying-ctmm-to-watlas-data.html#cb27-17"></a>                                         <span class="dt">infPatchSpatDiff =</span> <span class="dv">100</span>)</span>
<span id="cb27-18"><a href="applying-ctmm-to-watlas-data.html#cb27-18"></a>        </span>
<span id="cb27-19"><a href="applying-ctmm-to-watlas-data.html#cb27-19"></a>        <span class="co"># watlasUtils function to classify path</span></span>
<span id="cb27-20"><a href="applying-ctmm-to-watlas-data.html#cb27-20"></a>        temp_data &lt;-<span class="st"> </span><span class="kw">wat_classify_points</span>(<span class="dt">somedata =</span> temp_data,</span>
<span id="cb27-21"><a href="applying-ctmm-to-watlas-data.html#cb27-21"></a>                                         <span class="dt">resTimeLimit =</span> <span class="dv">2</span>)</span>
<span id="cb27-22"><a href="applying-ctmm-to-watlas-data.html#cb27-22"></a>        </span>
<span id="cb27-23"><a href="applying-ctmm-to-watlas-data.html#cb27-23"></a>        <span class="co"># watlasUtils function to get patches</span></span>
<span id="cb27-24"><a href="applying-ctmm-to-watlas-data.html#cb27-24"></a>        patch_data &lt;-<span class="st"> </span><span class="kw">wat_make_res_patch</span>(<span class="dt">somedata =</span> temp_data,</span>
<span id="cb27-25"><a href="applying-ctmm-to-watlas-data.html#cb27-25"></a>                                         <span class="dt">bufferSize =</span> <span class="dv">10</span>,</span>
<span id="cb27-26"><a href="applying-ctmm-to-watlas-data.html#cb27-26"></a>                                         <span class="dt">spatIndepLim =</span> <span class="dv">100</span>,</span>
<span id="cb27-27"><a href="applying-ctmm-to-watlas-data.html#cb27-27"></a>                                         <span class="dt">tempIndepLim =</span> <span class="dv">30</span>,</span>
<span id="cb27-28"><a href="applying-ctmm-to-watlas-data.html#cb27-28"></a>                                         <span class="dt">restIndepLim =</span> <span class="dv">30</span>,</span>
<span id="cb27-29"><a href="applying-ctmm-to-watlas-data.html#cb27-29"></a>                                         <span class="dt">minFixes =</span> <span class="dv">3</span>,</span>
<span id="cb27-30"><a href="applying-ctmm-to-watlas-data.html#cb27-30"></a>                                         <span class="dt">tideLims =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">10</span>))</span>
<span id="cb27-31"><a href="applying-ctmm-to-watlas-data.html#cb27-31"></a>        </span>
<span id="cb27-32"><a href="applying-ctmm-to-watlas-data.html#cb27-32"></a>        <span class="co"># get patch data points</span></span>
<span id="cb27-33"><a href="applying-ctmm-to-watlas-data.html#cb27-33"></a>        patch_points &lt;-<span class="st"> </span><span class="kw">wat_get_patch_summary</span>(<span class="dt">resPatchData =</span> patch_data,</span>
<span id="cb27-34"><a href="applying-ctmm-to-watlas-data.html#cb27-34"></a>                                              <span class="dt">dataColumn =</span> <span class="st">&quot;data&quot;</span>,</span>
<span id="cb27-35"><a href="applying-ctmm-to-watlas-data.html#cb27-35"></a>                                              <span class="dt">whichData =</span> <span class="st">&quot;points&quot;</span>)</span>
<span id="cb27-36"><a href="applying-ctmm-to-watlas-data.html#cb27-36"></a>      },</span>
<span id="cb27-37"><a href="applying-ctmm-to-watlas-data.html#cb27-37"></a>      <span class="co"># null error function, with option to collect data on errors</span></span>
<span id="cb27-38"><a href="applying-ctmm-to-watlas-data.html#cb27-38"></a>      <span class="dt">error=</span> <span class="cf">function</span>(e)</span>
<span id="cb27-39"><a href="applying-ctmm-to-watlas-data.html#cb27-39"></a>      {</span>
<span id="cb27-40"><a href="applying-ctmm-to-watlas-data.html#cb27-40"></a>        <span class="kw">message</span>(glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">&#39;patches {id}_{tide_number} errored&#39;</span>))</span>
<span id="cb27-41"><a href="applying-ctmm-to-watlas-data.html#cb27-41"></a>      }</span>
<span id="cb27-42"><a href="applying-ctmm-to-watlas-data.html#cb27-42"></a>      </span>
<span id="cb27-43"><a href="applying-ctmm-to-watlas-data.html#cb27-43"></a>    )</span>
<span id="cb27-44"><a href="applying-ctmm-to-watlas-data.html#cb27-44"></a>  }</span>
<span id="cb27-45"><a href="applying-ctmm-to-watlas-data.html#cb27-45"></a>  </span>
<span id="cb27-46"><a href="applying-ctmm-to-watlas-data.html#cb27-46"></a>  <span class="cf">if</span>(<span class="st">&quot;data.frame&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">class</span>(patch_points)){</span>
<span id="cb27-47"><a href="applying-ctmm-to-watlas-data.html#cb27-47"></a>    ratio &lt;-<span class="st"> </span><span class="kw">tryCatch</span>({</span>
<span id="cb27-48"><a href="applying-ctmm-to-watlas-data.html#cb27-48"></a>      <span class="co"># prepare for telemetry</span></span>
<span id="cb27-49"><a href="applying-ctmm-to-watlas-data.html#cb27-49"></a>      {</span>
<span id="cb27-50"><a href="applying-ctmm-to-watlas-data.html#cb27-50"></a>        data_for_ctmm &lt;-<span class="st"> </span><span class="kw">setDT</span>(patch_points)[,.(id, tide_number, x, y, patch, time, VARX, VARY)]</span>
<span id="cb27-51"><a href="applying-ctmm-to-watlas-data.html#cb27-51"></a>        </span>
<span id="cb27-52"><a href="applying-ctmm-to-watlas-data.html#cb27-52"></a>        <span class="co"># aggregate within a patch to 10 seconds</span></span>
<span id="cb27-53"><a href="applying-ctmm-to-watlas-data.html#cb27-53"></a>        data_for_ctmm &lt;-<span class="st"> </span><span class="kw">split</span>(data_for_ctmm, <span class="dt">f =</span> data_for_ctmm<span class="op">$</span>patch)</span>
<span id="cb27-54"><a href="applying-ctmm-to-watlas-data.html#cb27-54"></a>        </span>
<span id="cb27-55"><a href="applying-ctmm-to-watlas-data.html#cb27-55"></a>        data_for_ctmm &lt;-<span class="st"> </span><span class="kw">map</span>(data_for_ctmm, wat_agg_data, <span class="dt">interval =</span> <span class="dv">15</span>) <span class="op">%&gt;%</span></span>
<span id="cb27-56"><a href="applying-ctmm-to-watlas-data.html#cb27-56"></a><span class="st">          </span><span class="kw">keep</span>(<span class="cf">function</span>(z) <span class="kw">nrow</span>(z) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb27-57"><a href="applying-ctmm-to-watlas-data.html#cb27-57"></a><span class="st">          </span><span class="kw">bind_rows</span>()</span>
<span id="cb27-58"><a href="applying-ctmm-to-watlas-data.html#cb27-58"></a>        </span>
<span id="cb27-59"><a href="applying-ctmm-to-watlas-data.html#cb27-59"></a>        <span class="co"># make each patch an indiv</span></span>
<span id="cb27-60"><a href="applying-ctmm-to-watlas-data.html#cb27-60"></a>        <span class="kw">setDT</span>(data_for_ctmm)</span>
<span id="cb27-61"><a href="applying-ctmm-to-watlas-data.html#cb27-61"></a>        data_for_ctmm[,individual.local.identifier<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste</span>(id, tide_number, patch,</span>
<span id="cb27-62"><a href="applying-ctmm-to-watlas-data.html#cb27-62"></a>                                                           <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)]</span>
<span id="cb27-63"><a href="applying-ctmm-to-watlas-data.html#cb27-63"></a>        <span class="co"># get horizontal error</span></span>
<span id="cb27-64"><a href="applying-ctmm-to-watlas-data.html#cb27-64"></a>        data_for_ctmm[,HDOP <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sqrt</span>(VARX<span class="op">+</span>VARY)<span class="op">/</span><span class="dv">10</span>]</span>
<span id="cb27-65"><a href="applying-ctmm-to-watlas-data.html#cb27-65"></a>        <span class="co"># subset columns</span></span>
<span id="cb27-66"><a href="applying-ctmm-to-watlas-data.html#cb27-66"></a>        data_for_ctmm &lt;-<span class="st"> </span>data_for_ctmm[,.(individual.local.identifier, time, x, y, HDOP)]</span>
<span id="cb27-67"><a href="applying-ctmm-to-watlas-data.html#cb27-67"></a>        </span>
<span id="cb27-68"><a href="applying-ctmm-to-watlas-data.html#cb27-68"></a>        <span class="co"># get new names</span></span>
<span id="cb27-69"><a href="applying-ctmm-to-watlas-data.html#cb27-69"></a>        <span class="kw">setnames</span>(data_for_ctmm, <span class="dt">old =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;time&quot;</span>), </span>
<span id="cb27-70"><a href="applying-ctmm-to-watlas-data.html#cb27-70"></a>                 <span class="dt">new =</span> <span class="kw">c</span>(<span class="st">&quot;UTM.x&quot;</span>,<span class="st">&quot;UTM.y&quot;</span>, <span class="st">&quot;timestamp&quot;</span>))</span>
<span id="cb27-71"><a href="applying-ctmm-to-watlas-data.html#cb27-71"></a>        </span>
<span id="cb27-72"><a href="applying-ctmm-to-watlas-data.html#cb27-72"></a>        <span class="co"># convert time to posixct</span></span>
<span id="cb27-73"><a href="applying-ctmm-to-watlas-data.html#cb27-73"></a>        data_for_ctmm[,timestamp<span class="op">:</span><span class="er">=</span><span class="kw">as.POSIXct</span>(timestamp, <span class="dt">origin =</span> <span class="st">&quot;1970-01-01&quot;</span>)]</span>
<span id="cb27-74"><a href="applying-ctmm-to-watlas-data.html#cb27-74"></a>        <span class="co"># add UTM zone</span></span>
<span id="cb27-75"><a href="applying-ctmm-to-watlas-data.html#cb27-75"></a>        data_for_ctmm[,zone<span class="op">:</span><span class="er">=</span><span class="st">&quot;31 +north&quot;</span>]</span>
<span id="cb27-76"><a href="applying-ctmm-to-watlas-data.html#cb27-76"></a>        </span>
<span id="cb27-77"><a href="applying-ctmm-to-watlas-data.html#cb27-77"></a>      }</span>
<span id="cb27-78"><a href="applying-ctmm-to-watlas-data.html#cb27-78"></a>      </span>
<span id="cb27-79"><a href="applying-ctmm-to-watlas-data.html#cb27-79"></a>      <span class="co"># make telemetry</span></span>
<span id="cb27-80"><a href="applying-ctmm-to-watlas-data.html#cb27-80"></a>      {</span>
<span id="cb27-81"><a href="applying-ctmm-to-watlas-data.html#cb27-81"></a>        tel &lt;-<span class="st"> </span><span class="kw">as.telemetry</span>(data_for_ctmm)</span>
<span id="cb27-82"><a href="applying-ctmm-to-watlas-data.html#cb27-82"></a>      }</span>
<span id="cb27-83"><a href="applying-ctmm-to-watlas-data.html#cb27-83"></a>      </span>
<span id="cb27-84"><a href="applying-ctmm-to-watlas-data.html#cb27-84"></a>      n_patches &lt;-<span class="st"> </span><span class="kw">length</span>(tel)</span>
<span id="cb27-85"><a href="applying-ctmm-to-watlas-data.html#cb27-85"></a>      </span>
<span id="cb27-86"><a href="applying-ctmm-to-watlas-data.html#cb27-86"></a>      <span class="co"># ctmm section</span></span>
<span id="cb27-87"><a href="applying-ctmm-to-watlas-data.html#cb27-87"></a>      {</span>
<span id="cb27-88"><a href="applying-ctmm-to-watlas-data.html#cb27-88"></a>        <span class="co"># get the outliers but do not plot</span></span>
<span id="cb27-89"><a href="applying-ctmm-to-watlas-data.html#cb27-89"></a>        outliers &lt;-<span class="st"> </span><span class="kw">map</span>(tel, outlie, <span class="dt">plot=</span><span class="ot">FALSE</span>)</span>
<span id="cb27-90"><a href="applying-ctmm-to-watlas-data.html#cb27-90"></a>        <span class="co"># get a list of 99 th percentile outliers</span></span>
<span id="cb27-91"><a href="applying-ctmm-to-watlas-data.html#cb27-91"></a>        q90 &lt;-<span class="st"> </span><span class="kw">map</span>(outliers, <span class="cf">function</span>(this_outlier_set){</span>
<span id="cb27-92"><a href="applying-ctmm-to-watlas-data.html#cb27-92"></a>          <span class="kw">quantile</span>(this_outlier_set[[<span class="dv">1</span>]], <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.99</span>))</span>
<span id="cb27-93"><a href="applying-ctmm-to-watlas-data.html#cb27-93"></a>        })</span>
<span id="cb27-94"><a href="applying-ctmm-to-watlas-data.html#cb27-94"></a>        <span class="co"># remove outliers from telemetry data</span></span>
<span id="cb27-95"><a href="applying-ctmm-to-watlas-data.html#cb27-95"></a>        tel &lt;-<span class="st"> </span><span class="kw">pmap</span>(<span class="kw">list</span>(tel, outliers, q90), </span>
<span id="cb27-96"><a href="applying-ctmm-to-watlas-data.html#cb27-96"></a>                    <span class="cf">function</span>(this_tel_obj, this_outlier_set, outlier_quantile) </span>
<span id="cb27-97"><a href="applying-ctmm-to-watlas-data.html#cb27-97"></a>                    {this_tel_obj[<span class="op">-</span>(<span class="kw">which</span>(this_outlier_set[[<span class="dv">1</span>]] <span class="op">&gt;=</span><span class="st"> </span>outlier_quantile)),]})</span>
<span id="cb27-98"><a href="applying-ctmm-to-watlas-data.html#cb27-98"></a>        </span>
<span id="cb27-99"><a href="applying-ctmm-to-watlas-data.html#cb27-99"></a>        <span class="co"># some patches have no data remaining, filter them out</span></span>
<span id="cb27-100"><a href="applying-ctmm-to-watlas-data.html#cb27-100"></a>        tel &lt;-<span class="st"> </span><span class="kw">keep</span>(tel, <span class="cf">function</span>(this_tel){<span class="kw">nrow</span>(this_tel) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>})</span>
<span id="cb27-101"><a href="applying-ctmm-to-watlas-data.html#cb27-101"></a>        </span>
<span id="cb27-102"><a href="applying-ctmm-to-watlas-data.html#cb27-102"></a>        r_patches &lt;-<span class="st"> </span><span class="kw">length</span>(tel)</span>
<span id="cb27-103"><a href="applying-ctmm-to-watlas-data.html#cb27-103"></a>      }</span>
<span id="cb27-104"><a href="applying-ctmm-to-watlas-data.html#cb27-104"></a>      ratio =<span class="st"> </span>r_patches<span class="op">/</span>n_patches</span>
<span id="cb27-105"><a href="applying-ctmm-to-watlas-data.html#cb27-105"></a>      <span class="kw">message</span>(ratio)</span>
<span id="cb27-106"><a href="applying-ctmm-to-watlas-data.html#cb27-106"></a>      <span class="kw">return</span>(ratio)</span>
<span id="cb27-107"><a href="applying-ctmm-to-watlas-data.html#cb27-107"></a>    },</span>
<span id="cb27-108"><a href="applying-ctmm-to-watlas-data.html#cb27-108"></a>    <span class="dt">error=</span> <span class="cf">function</span>(e)</span>
<span id="cb27-109"><a href="applying-ctmm-to-watlas-data.html#cb27-109"></a>    {</span>
<span id="cb27-110"><a href="applying-ctmm-to-watlas-data.html#cb27-110"></a>      <span class="co">#return(NA)</span></span>
<span id="cb27-111"><a href="applying-ctmm-to-watlas-data.html#cb27-111"></a>    })</span>
<span id="cb27-112"><a href="applying-ctmm-to-watlas-data.html#cb27-112"></a>  }</span>
<span id="cb27-113"><a href="applying-ctmm-to-watlas-data.html#cb27-113"></a>  </span>
<span id="cb27-114"><a href="applying-ctmm-to-watlas-data.html#cb27-114"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="applying-ctmm-to-watlas-data.html#cb28-1"></a><span class="co"># get ratios</span></span>
<span id="cb28-2"><a href="applying-ctmm-to-watlas-data.html#cb28-2"></a>data_to_test<span class="op">$</span>ratio &lt;-<span class="st"> </span><span class="kw">map_if</span>(<span class="dt">.x =</span> some_output, <span class="dt">.p =</span> is.null, <span class="dt">.f =</span> <span class="cf">function</span>(l){<span class="ot">NA</span>}) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb28-3"><a href="applying-ctmm-to-watlas-data.html#cb28-3"></a><span class="st">  </span><span class="kw">unlist</span>()</span>
<span id="cb28-4"><a href="applying-ctmm-to-watlas-data.html#cb28-4"></a></span>
<span id="cb28-5"><a href="applying-ctmm-to-watlas-data.html#cb28-5"></a><span class="co"># plot ratios</span></span>
<span id="cb28-6"><a href="applying-ctmm-to-watlas-data.html#cb28-6"></a>fig_patch_thinning &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_to_test)<span class="op">+</span></span>
<span id="cb28-7"><a href="applying-ctmm-to-watlas-data.html#cb28-7"></a><span class="st">  </span><span class="kw">geom_jitter</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(scales), <span class="dt">y =</span> ratio, </span>
<span id="cb28-8"><a href="applying-ctmm-to-watlas-data.html#cb28-8"></a>                  <span class="dt">group =</span> scales, <span class="dt">col =</span> <span class="kw">factor</span>(scales), </span>
<span id="cb28-9"><a href="applying-ctmm-to-watlas-data.html#cb28-9"></a>                  <span class="dt">shape =</span> <span class="kw">factor</span>(scales)), <span class="dt">size =</span> <span class="dv">2</span>,</span>
<span id="cb28-10"><a href="applying-ctmm-to-watlas-data.html#cb28-10"></a>              <span class="dt">stroke =</span> <span class="dv">1</span>)<span class="op">+</span></span>
<span id="cb28-11"><a href="applying-ctmm-to-watlas-data.html#cb28-11"></a><span class="st">  </span><span class="kw">scale_fill_brewer</span>()<span class="op">+</span></span>
<span id="cb28-12"><a href="applying-ctmm-to-watlas-data.html#cb28-12"></a><span class="st">  </span><span class="kw">scale_shape_few</span>()<span class="op">+</span></span>
<span id="cb28-13"><a href="applying-ctmm-to-watlas-data.html#cb28-13"></a><span class="st">  </span><span class="kw">theme_few</span>()<span class="op">+</span></span>
<span id="cb28-14"><a href="applying-ctmm-to-watlas-data.html#cb28-14"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)<span class="op">+</span></span>
<span id="cb28-15"><a href="applying-ctmm-to-watlas-data.html#cb28-15"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;aggregation interval (s)&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;% patches retained&quot;</span>)</span>
<span id="cb28-16"><a href="applying-ctmm-to-watlas-data.html#cb28-16"></a></span>
<span id="cb28-17"><a href="applying-ctmm-to-watlas-data.html#cb28-17"></a><span class="co"># save to figs</span></span>
<span id="cb28-18"><a href="applying-ctmm-to-watlas-data.html#cb28-18"></a><span class="kw">ggsave</span>(<span class="dt">plot =</span> fig_patch_thinning, <span class="dt">filename =</span> <span class="st">&quot;figs/fig_patch_thinning.png&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="applying-ctmm-to-watlas-data.html#cb29-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;figs/fig_patch_thinning.png&quot;</span>)</span></code></pre></div>
<p><img src="figs/fig_patch_thinning.png" width="1038" /></p>

<div id="refs" class="references hanging-indent">
<div id="ref-bracis2018">
<p>Bracis, Chloe, Keith L. Bildstein, and Thomas Mueller. 2018. “Revisitation Analysis Uncovers Spatio-Temporal Patterns in Animal Movement Data.” <em>Ecography</em> 41 (11): 1801–11. <a href="https://doi.org/10.1111/ecog.03618">https://doi.org/10.1111/ecog.03618</a>.</p>
</div>
<div id="ref-calabrese2016">
<p>Calabrese, Justin M., Chris H. Fleming, and Eliezer Gurarie. 2016. “Ctmm: An R Package for Analyzing Animal Relocation Data as a Continuous-Time Stochastic Process.” <em>Methods in Ecology and Evolution</em> 7 (9): 1124–32. <a href="https://doi.org/10.1111/2041-210X.12559">https://doi.org/10.1111/2041-210X.12559</a>.</p>
</div>
<div id="ref-VulnToolkit2014">
<p>Troy D. Hill, Shimon C. Anisfeld. 2014. <em>VulnToolkit: R for Coastal Vulnerability Analysis</em>. New Haven, CT: Yale School of Forestry; Environmental Studies. <a href="https://github.com/troyhill/VulnToolkit">https://github.com/troyhill/VulnToolkit</a>.</p>
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="linking-patch-metrics-to-personality.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/pratikunterwegs/knotPatches/edit/master/07_supplement01_using_ctmm.rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
