---
editor_options: 
  chunk_output_type: console
---

```{r load_libs}
source("libs.R")
library(readr);library(viridis)
```

```{r load_all_birds}
#'load all birds
load("knots_data/knots01_data.rdata")
day30 <- as.numeric(as.POSIXct("2017-09-24", tz = "CEST", origin = "1970-01-01"))

for(i in 1:length(k1.data)){
  k1.data[[i]]$id = names(k1.data)[i]
}

#'filter one month
k1.data <- k1.data %>% rbind_list() %>% filter(ts < "2017-09-23")

#'get 1 minute means
k1 <- k1.data %>% mutate(time_round = round_date(ts, "minute")) %>% 
  group_by(id, time_round) %>% 
  summarise_all(funs(mean(., na.rm = T)))
```

```{r load_pskf_functions}
#'source from file
source("PSKF.R")
```

```{r run_pskf}
#'get pskf data
pskf_data = k1 %>% dlply("id") %>% 
  map(function(x) x %>% arrange(TIME) %>% select(X,Y,COVXY,VARX,VARY,TIME))

#"run pskf and write to csv"
for(i in 1:length(pskf_data)){
  x <- PSKF(pskf_data[[i]])
  write_csv(x, path = paste("knots_data/knots_pskf/",names(pskf_data)[i],"pskf.csv", sep=""))
  rm(x)
  gc()
}
```

```{r load_pskf_data}
#'load from csv
pskf_files = list.files("knots_data/knots_pskf/", pattern = "pskf.csv", full.names = T)

#'run map
pskf_files = pskf_files %>% map(read_csv)
#'assign names
names(pskf_files) = pskf_data_ids
for(i in 1:length(pskf_files)){
  pskf_files[[i]]$id = filtered_data_ids[i]
}
```

