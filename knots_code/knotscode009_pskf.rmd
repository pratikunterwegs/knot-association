---
editor_options: 
  chunk_output_type: console
---

```{r load_libs}
source("libs.R")
library(readr);library(viridis)
```

```{r load_all_birds}
#'load all birds
load("knots_data/knots01_data.rdata")
day30 <- as.numeric(as.POSIXct("2017-09-24", tz = "CEST", origin = "1970-01-01"))

for(i in 1:length(k1.data)){
  k1.data[[i]]$id = names(k1.data)[i]
}

#'filter one month
k1.data <- k1.data %>% rbind_list() %>% filter(ts < "2017-09-23", NBS > 3)

#'get 1 minute means
k1 <- k1.data %>% mutate(time_round = round_date(ts, "minute")) %>% 
  group_by(id, time_round) %>% 
  summarise_all(funs(mean(., na.rm = T)))

load("knots_data/k1.tides.rdata")

k1.tide <- k1 %>% dlply("id") %>% 
  map(function(x){
    full_join(x, tide, by = c("time_round" = "time")) %>% arrange(time_round) %>% mutate(tide = ifelse(is.na(tide), "other", tide)) %>% mutate(ht = cumsum(tide == "H")+1)
  }) %>% bind_rows() %>% dlply(c("id","ht"))
```

```{r}
#'get distances and remove unrealistic distances
k1.tide <- k1.tide[unlist(lapply(k1.tide, function(x) sum(!is.na(x$X)))) > 3]

for(i in 1:length(k1.tide)){
  a <- k1.tide[[i]]
  a$distance <- c(NA, spDists(x = a[,c("X","Y")], segments = T))
  k1.tide[[i]] <- a
}

#'identify segments as moves over 95th percentile
k1.tide <- k1.tide %>% 
  map(function(x){
    filter(x, !is.na(distance)) %>% mutate(segment = cumsum(distance > 120))
  })

#'split by segment, remove small segments under 5 positions
k1.tide <- k1.tide %>% 
  bind_rows() %>% 
  dlply(c("id","ht","segment"))
k1.tide <- k1.tide[unlist(lapply(k1.tide, nrow)) > 3]
```

```{r}
#'this looks great! but not worth a PSKF right now.
#'save for use with the HF proximity code
k1.tide <- bind_rows(unclass(k1.tide)) %>% dlply(c("id","ht"))
```


```{r load_pskf_functions}
#'source from file
source("PSKFForATLAS.R")
library(readr)
```

```{r run_pskf}
#'get pskf data
pskf_data <- k1.tide %>% 
  map(function(x) arrange(x, TIME) %>% select(X,Y,COVXY,VARX,VARY,TIME))

pskf_data <- pskf_data[unlist(lapply(pskf_data, function(x) nrow(x) > 200))]

#"run pskf and write to csv"
for(i in 7:length(pskf_data)){
  x <- PSKFForATLAS(pskf_data[[i]])
  write_csv(x, path = paste("knots_data/knots_pskf/",names(pskf_data)[i],"pskf.csv", sep=""))
  rm(x)
  gc()
}
```

```{r load_pskf_data}
#'load from csv
pskf_files = list.files("knots_data/knots_pskf/", pattern = "pskf.csv", full.names = T)

#'run map
pskf_files = pskf_files %>% map(read_csv)
#'assign names
names(pskf_files) = pskf_data_ids
for(i in 1:length(pskf_files)){
  pskf_files[[i]]$id = filtered_data_ids[i]
}
```

