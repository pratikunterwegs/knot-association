---
chunk_output_type: console
---
```{r}
#'source libs
source("libs.R")
library(readr)
```

```{r}
#'read in segmented files
files = list.files("knots_data/segmented_residence_data/", pattern = ".csv", full.names = T)

data.segments = files %>%
  map(function(x) read_csv(x, col_names = F))

#'load prepped data
load("knots_data/knots01_for_residence_segments.rdata")
```

```{r}
#'assign names to data.segments
names(data.segments) = names(data)
#'identify segments where there is no data, ie, no change in segments
which(unlist(lapply(data.segments, ncol)) == 0)
#'remove bad dfs
data.segments = data.segments[unlist(lapply(data.segments, ncol)) == 6]
#'make colnames
colnames = colnames(data[[1]])
#'assign id.ht to the dfs
for(i in 1:length(data.segments)){
  colnames(data.segments[[i]]) = colnames; 
  data.segments[[i]] = data.segments[[i]] %>% 
    mutate(id.ht = names(data.segments)[i],
           index = 1)
}

#'assign id.ht to the prepped data
for(i in 1:length(data)){
  data[[i]]$id.ht = names(data)[i]
}
```

```{r}
#'bind rows and merge
data = data %>%
  bind_rows() %>% 
  full_join(data.segments %>% 
              bind_rows())
```

```{r}
#'bind by id.ht and split again
data = data %>% 
  arrange(id.ht, time) %>% 
  mutate(index = ifelse(is.na(index), 0, index)) %>% 
  mutate(id = substr(id.ht, 1, 3), 
         ht = substr(id.ht, 5, 7))
```

```{r}
#'split by id.ht and prep the segment ids from reps of rle
data = data %>%
  dlply("id.ht")

seg.rle = vector("list", length=length(data))

#'run a for loop to id the segs
for(i in 1:length(data)){
  x = unclass(rle(data[[i]]$index)) %>% 
    bind_rows() %>% 
    filter(values == 0)
  seg.rle[[i]] = data_frame(seg = rep(1:nrow(x), x$lengths))
  data[[i]] = data[[i]] %>% 
    filter(index == 0) %>% 
    bind_cols(seg.rle[[i]])
}
```


```{r}
#'plot segments
data2 = data %>% rbind_list() 

data2 %>% filter(id.ht == "151.003") %>% 
ggplot()+
  geom_line(aes(x = as.POSIXct(time, origin = "1970-01-01"), y = residence, col = as.factor(seg)), lwd = 2)+
  facet_grid(id~ht, scales = "free")
```

