---
chunk_output_type: console
editor_options: 
  chunk_output_type: console
---
```{r}
source("libs.R");library(sp)
```

# Data filtering here

```{r load_all_birds}
#'load all birds
load("knots_data/knots01_data.rdata")
day30 <- as.numeric(as.POSIXct("2017-09-24", tz = "CEST", origin = "1970-01-01"))

for(i in 1:length(k1.data)){
  k1.data[[i]]$id = names(k1.data)[i]
}

#'filter one month
k1.data <- k1.data %>% rbind_list() %>% filter(ts < "2017-09-23")

#'get 1 minute means
k1 <- k1.data %>% mutate(time_round = round_date(ts, "minute")) %>% 
  group_by(id, time_round) %>% 
  summarise_all(funs(mean(., na.rm = T)))

load("knots_data/k1.tides.rdata")

k1.tide <- k1 %>% dlply("id") %>% 
  map(function(x){
    full_join(x, tide, by = c("time_round" = "time")) %>% arrange(time_round) %>% mutate(tide = ifelse(is.na(tide), "other", tide)) %>% mutate(ht = cumsum(tide == "H")+1)
  }) %>% bind_rows() %>% dlply(c("id","ht"))
```

```{r median_filter}
#'get distances and remove unrealistic distances
k1.tide <- k1.tide[unlist(lapply(k1.tide, function(x) sum(!is.na(x$X)))) > 0.3*12*60]

#'apply a 5-point median filter
k1.tide <- map(k1.tide, function(x){
  filter(x, abs(COVXY) < 1e3) %>% 
  mutate(X = runmed(X, 5), Y = runmed(Y, 5))
})

#'remove low data tides
k1.tide <- k1.tide[unlist(lapply(k1.tide, function(x) sum(!is.na(x$X)))) > 0.3*12*60]
```

```{r distances_hist}
for(i in 1:length(k1.tide)){
  a <- k1.tide[[i]]
  a$distance <- c(NA, spDists(x = a[,c("X","Y")], segments = T))
  k1.tide[[i]] <- a
}

#'identify segments as moves over 95th percentile
#k1.tide <- k1.tide %>% 
#  map(function(x){
#    filter(x, !is.na(distance)) %>% mutate(segment = cumsum(distance > 120))
#  })

#'split by segment, remove small segments under 5 positions
#k1.tide <- k1.tide %>% 
#  bind_rows() %>% 
#  dlply(c("id","ht","segment"))
#k1.tide <- k1.tide[unlist(lapply(k1.tide, nrow)) > 3]
```

```{r}
#'this looks great! but not worth a PSKF right now.
#'save for use with the HF proximity code
k1.tide <- bind_rows(unclass(k1.tide)) %>% dlply(c("id","ht"))

#'note. knots01_short_segs has been saved as the same df, delete it
save(k1.tide, file = "knots_data/knots01_median_filter.rdata")
```

# Tide matching here

```{r prep_for_segments}
#'prep data, remove point with fpt less than 10 mins
#data.prep = data %>% filter(fpt > 10/60) %>% 
#  dlply("id.ht")
load("knots_data/knots01_median_filter.rdata")

#'get dummy data, and time since high tide
data.prep <- k1.tide %>% 
  map(function(x){
    arrange(x, TIME) %>% mutate(ht.time = round(TIME/1e3 - first(TIME/1e3)))
  })

#'remove tracks with less than 60 positions remaining , ie, data.prep with less than 60 positions
#data.prep = data.prep[unlist(map(data.prep, nrow))>= 60]
```

```{r}
#'load tides
load("knots_data/k1.tides.rdata")
#'in each tide get the list of potential times in mins
tide.mins <- tide %>%
  filter(tide == "H") %>% 
  mutate(ht = cumsum(tide == "H")+1,
         time = round_date(time, "minute")) %>% 
  dlply("ht")

#'get minute sequence
for (i in 1:(length(tide.mins)-1)){
  tide.mins[[i]] <- data_frame(time = seq(tide.mins[[i]]$time, tide.mins[[(i+1)]]$time, 60), ht = as.numeric(names(tide.mins)[i]))
}

#'bind rows
tide.mins <- rbind_list(tide.mins)
```

```{r}
#'left bind the tracking data with the expected minutes by tide
data.tide <- data.prep %>% 
  map(function(x){
    x %>% mutate(ht = as.numeric(ht)) %>%
      right_join(tide.mins %>% filter(ht == as.numeric(x$ht)), by = c("time_round"="time","ht"))
  })

#'save this data
save(data.tide, file = "knots_data/knots01_tide_minute_matched.rdata")
```

```{r}
#'load data from here
load("knots_data/knots01_tide_minute_matched.rdata")
```


```{r}
#'assign tide and id to each element of the list
data.tide <- data.tide %>% 
  map(function(x) {x %>% mutate(ht = first(ht[!is.na(ht)]),
      id = first(id[!is.na(id)]))})
```

```{r}
#'bind rows, get the time since high tide, ungroup, assign values in pplace of NAs
data.tide <- rbind_list(data.tide) %>% 
  group_by(ht = as.factor(ht)) %>% 
  mutate(ht.time = as.numeric(time_round) - min(as.numeric(time_round), na.rm = T)) %>% 
  ungroup() %>% 
  mutate(X = ifelse(is.na(X), 9e9,X), Y = ifelse(is.na(Y), 9e9,Y)) %>% 
  dlply("ht")

data.tide <- data.tide %>% 
  map(function(x){
    x %>% filter(!is.na(id))
  })

save(data.tide, file = "knots_data/kntoscode023_tidematched_data.rdata")
```