---
output: html_document
editor_options:
  chunk_output_type: console
---
```{r}
source("libs.R");library(sp)
load("knots_data/kntoscode023_tidematched_data.rdata")
library(stringi)
#'get ht data, get the FLOORed hour, not the rounded
data <- unclass(data.tide) %>%
  bind_rows() %>%
  #anti_join(unclass(data.lt) %>% bind_rows()) %>%
  mutate(hour = stri_pad(floor(ht.time/3600), width = 2, pad = "0"),
         ht = stri_pad(ht, width = 2, pad = "0"))

#'assign a tidal interval
data <- data %>%
 # map(function(x){
 #   mutate(x, tide = ifelse(is.na(tide),"other",tide),
 #          lt = cumsum(tide == "L")+1) %>%
 #     filter(tide != "L")
 #}) %>% unclass() %>% bind_rows() %>%
  dlply(c("ht"))

#'remove tides with < 5 birds
data <- data[unlist(lapply(data, function(x) length(unique(x$id[!is.na(x$id)])))) >= 5]
```

```{r}
library(sp)
#'this method is simpler than in knotscode019.
proximity <- data_frame()

for(z in 1:length(data)){
#'split again by id
focals <- dlply(data[[z]], "id")
#'implement method from knotscode019
for(i in 1:length(focals)){
  #'get focals
  #'get the nonfocal birds
  nonfocals <- focals[!names(focals) %in% names(focals)[i]]

  #'loop over nonfocals
  for(j in 1:length(nonfocals)){
    distances <- spDists(as.matrix(focals[[i]][,c("X","Y")]), as.matrix(nonfocals[[j]][,c("X","Y")]), diagonal = T)
    #'get only distances where both focal and nonfocal positions are known
    #'set all distances greater than 9e6 = 0, and all rows where focal pos and all cols where nonfocal pos are > 9e6
    distances[focals[[i]]$X > 9e6 | nonfocals[[j]]$Y > 9e6] <- NA
    #distances <- diag(distances)
    interactions <- data_frame(distances = sum(distances <= 250, na.rm = T)) %>%
      #count(class) %>%
      mutate(focal = unique(focals[[i]]$id),
             nonfocal = unique(nonfocals[[j]]$id),
             ht = unique(focals[[i]]$ht),
             pos_focal = sum(focals[[i]]$X < 9e9),
             pos_nonfocal = sum(nonfocals[[j]]$X < 9e9))
    proximity <- rbind(proximity, interactions)
    }
  }
}
```

```{r}
#'calculate coherence scores for under 250m
proximity <- proximity %>%
  dlply(c("ht")) %>%
  map(function(x){
    x %>% group_by(focal, nonfocal, ht) %>%
  summarise(pos_focal = first(pos_focal),
            pos_nonfocal = first(pos_nonfocal),
    interactions = sum(distances),
            coherence_emp = case_when(
    pos_focal == 0 & pos_nonfocal == 0 ~ as.double(NA),
    T ~ interactions/(first(pos_focal))))
}) %>%
  bind_rows()

#'get all possible pairs
pairs <- expand(ungroup(bind_rows(proximity)), focal, nonfocal) %>% mutate(pair = 1:nrow(.))

#'assign pairs, do not remove non-unique pairs, ie, keep both a-b and b-a FOR NOW to construct the simulated coherence matrices
proximity <- left_join(proximity, pairs)
```

```{r run KS test}
proximity_compare <- proximity %>%
  filter(focal < nonfocal) %>%
  dlply("pair")

#proximity_compare <- proximity_compare[unlist(lapply(proximity_compare, nrow)) >= 10]

for(i in 1:length(proximity_compare)){

x <- proximity_compare[[i]]
y <- proximity %>% anti_join(x) %>% .$coherence_emp
  #'run the KS test
ks.res <- bind_cols(unclass(ks.test(x = x$coherence_emp, y = y)))

#'get emp mean and sim mean
x <- summarise(x, c_emp = mean(coherence_emp, na.rm = T),
                 c_sim = mean(y, na.rm = T))
proximity_compare[[i]] <- x %>% bind_cols(ks.res)
}

#'get tested pairs df
pairs_test <- data_frame(pair = as.numeric(names(proximity_compare))) %>% left_join(pairs)

#'bind the list rows
pairs_test <- bind_rows(unclass(proximity_compare)) %>%
  #'bind the test data to the pairs data
  bind_cols(pairs_test) %>%
  dplyr::select(statistic, p.value, pair, focal, nonfocal, c_emp, c_sim)
```

```{r coherence_test_plot}
#count(pairs_test, sig = p.value <= 0.05, friends = c_emp > c_sim)

cairo_ps(filename = "figure_coherence_test_improved.eps", width = 150/25.4, height = 150/25.4)

#'visualise for poster
ggplot()+
  #geom_point(data =expand(data_frame(x = c(1:35),y = c(1:35)), x,y) %>% filter(x<y), aes(x = as.factor(x), y = as.factor(y)), size = 1, shape = 4, col = "grey30")+
 
  geom_tile(data = pairs_test, aes(x = (as.factor(focal)), y = (as.factor(nonfocal)), fill = c_emp), col = "white", size = 1)+
  geom_tile(data = pairs_test, aes(x = (as.factor(focal)), y = (as.factor(nonfocal)), fill = c_emp, alpha = p.value <= 0.05), col = "white", size = 1)+
  #scale_x_discrete(labels = c(1:35))+
  #scale_y_discrete(labels = c(1:35))+
    theme_poster()+
  theme(axis.text.x = element_text(size = 8, angle = 90),
        axis.text.y = element_text(size = 11, colour = "grey30"),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        legend.text = element_text(size = 12, angle = 0),
        axis.ticks = element_blank(),
        axis.ticks.y = element_line(color = "grey"),
       # panel.grid.major = element_line(colour = "grey90"),
       # legend.title = element_text(size = 14),
       legend.position = c(0.6,0.5),
       legend.background = element_blank(),
       legend.justification = c(0,1))+

  scale_fill_viridis(option = "inferno", direction = -1)+
  scale_alpha_manual(values = c(0,1), guide = F)+
  
  geom_text(aes(x = 1:34, y = c(1:34)-2, label = c(1:34)), col = "grey30")+
  geom_text(aes(x = 1:34, y = 0:33, label = "|"), col= "grey")+
 # scale_x_discrete(labels = c(0:33))+
  
  labs(list(fill = "Association", x = "individual i", y = "individual j"))+
  coord_cartesian(xlim = c(0,36), ylim =c(-2,36))

dev.off()
```

```{r}
cairo_ps(filename = "coherence_distribution.eps", width = 150/25.4, height = 150/25.4, fallback_resolution = 600)
solcol = solarized_pal(accent = "blue")(9)

ggplot()+
  
  geom_histogram(data = proximity, aes(x = coherence_emp, y = ..count../sum(..count..)), geom = "line", fill = inferno(9)[6], col = "white", size=1.2)+
 # scale_fill_manual(values = brewer.pal(9,"YlOrBr")[5])+
  theme(legend.position = "none")+
  #coord_cartesian(ylim = c(0,0.1))+
  labs(list(x = "Pairwise association", y = "Proportion"))+
  theme_poster()

dev.off()
```

```{r}
cairo_ps(filename = "coherence_test_prop.eps", width = 150/25.4, height = 150/25.4, fallback_resolution = 600)

#'get plot of coherence positive or negative
count(pairs_test, friends = c_emp > c_sim, sig = p.value <=0.05) %>% mutate(prop = n/(sum(n))) %>%
  ggplot()+
  
  geom_tile(aes(x = friends, y = sig, fill = prop), col = "white", size = 3)+
  geom_text(aes(x = friends, y = sig, label = paste(round_any(prop*100,0.1), "%")), col =1, size = 12)+
  scale_fill_gradientn(colors = rev(brewer.pal(4,"YlOrBr")))+
  theme_poster()+
  theme(legend.position = "none")+
  labs(list(x = "Pairwise co-occurrence \n > random co-occurrence", y = "K-S test significance \n P-value â‰¤ 0.05"))

dev.off()
```
