```{r}
#### data for array based pairwise distances
source("libs.R")
library(readr)

load("knots_data/foraging_segments.rdata")
```

```{r}
#'convert to geographic coordinates for the geosphere package
library(sf)
k1.sf = st_as_sf(data.segmented, coords = c("x","y")) %>% 
  `st_crs<-`(32631) %>% 
  st_transform(4326) %>% bind_cols(data.frame(st_coordinates(.))) %>%
  `st_geometry<-`(NULL) %>% 
  unclass() %>% as.data.frame()

#'create a sequence of tiemstamps from min TIME to max TIME, in increments of 1000, or divide by 1e3 and have increments of 1s
#'

k2.time = data_frame(time_calc = seq(min(k2.2$time_round), max(k2.2$time_round), sample_interval))
#'make df again by removing geometry
```

```{r assign_timestamps}
#'split into lsit, and then merge each element to the timestamps df.
k2.3 = k2.2 %>% dlply("id") %>% map(function(x) full_join(k2.time, x, by = c("time_calc" = "time_round")))

#'assign id
for (i in 1:length(k2.3)) {
  k2.3[[i]]$id = names(k2.3)[i]
}

#'select a sample of the dfs, and select only x,y and id
a = k2.3 #%>% filter(id %in% c("151", "157","231"))
a = a %>% map(function(x)x %>% select(id,X,Y))

#'convert to matrix
a = a %>% map(function(x) x %>% mutate(id = NULL)) %>% map(as.matrix)

#'bind the matrices into an array along the third dimension
b = abind::abind(a, along = 3)
```

```{r}
#'now run the spdists functions through a for loop
#'load libs
library(geosphere)

d = array(dim = c(nrow(k2.time), length(a)-1, length(a)))
id.array = array(dim = c(nrow(k2.time), 5, length(a)))

for (i in 1:length(a)) {
  x = a[!names(a) %in% names(a)[i]]
  for(j in 1:length(x)){
    d[,j,i] = (distVincentyEllipsoid(p1 = a[[i]], p2 = x[[j]]))
  }
  e = d[,,i]
  z = apply(e, c(1), function(y){which(y %in% head(sort(y), 5))})
  #z2 = which(unlist(lapply(z, length)) < 5)

  for (k in 1:length(z)) {
    z[[k]] = c(z[[k]], rep(NA, 5 - length(z[[k]])))
    id.array[k,,i] = names(x)[z[[k]]]
  }

}

#'make each matrix of each array a df
e = d %>% apply(3, data.frame)

id.array = id.array %>% apply(3, data.frame)

#'assign names
names(e) = names(id.array) = names(a)

```

```{r set_colnames}
#'set colnames as the ids of the knots other than the focal knot
for (i in 1:length(e)) {
  colnames(e[[i]]) = names(e[!names(e) %in% names(e)[i]])
}

save(e, id.array, file = "knots_data/distance_matrix.rdata")
```
